// VillaCare Database Schema
// Uses Neon PostgreSQL with NextAuth.js

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// EXISTING TABLES (from your Neon database)
// ============================================

model cleaner_applications {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String    @db.VarChar(255)
  phone         String    @db.VarChar(20)
  referrer_name String    @db.VarChar(255)
  status        String?   @default("pending") @db.VarChar(20)
  notes         String?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  reviewed_at   DateTime? @db.Timestamptz(6)
}

model owner_waitlist {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email      String    @db.VarChar(255)
  town       String    @db.VarChar(100)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
}

// ============================================
// NextAuth.js Required Tables (NEW)
// ============================================

model User {
  id                String    @id @default(cuid())
  name              String?
  email             String?   @unique
  emailVerified     DateTime?
  phone             String?   @unique
  phoneVerified     DateTime?
  password          String?   // Hashed password for email login
  image             String?
  role              UserRole  @default(OWNER)
  preferredLanguage String    @default("en") @db.VarChar(10) // en, es, de, fr, nl, it, pt
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  accounts           Account[]
  sessions           Session[]
  cleaner            Cleaner?
  owner              Owner?
  adminConversations Conversation[] @relation("AdminConversations")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// VillaCare Domain Models (NEW)
// ============================================

enum UserRole {
  OWNER
  CLEANER
  ADMIN
}

enum CleanerStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum FeedbackCategory {
  IDEA
  ISSUE
  PRAISE
  QUESTION
}

enum FeedbackMood {
  LOVE
  LIKE
  MEH
  FRUSTRATED
}

enum FeedbackStatus {
  NEW
  REVIEWED
  PLANNED
  DONE
}

enum TeamJoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model Cleaner {
  id             String        @id @default(cuid())
  userId         String        @unique
  slug           String        @unique
  bio            String?       @db.Text
  reviewsLink    String?
  serviceAreas   String[]
  languages      String[]      @default(["es"]) // Languages the cleaner speaks (en, es, de, fr, nl, it, pt)
  hourlyRate     Decimal       @db.Decimal(10, 2)
  status         CleanerStatus @default(PENDING)
  totalBookings  Int           @default(0)
  rating         Decimal?      @db.Decimal(3, 2)
  reviewCount    Int           @default(0)
  featured       Boolean       @default(false)
  teamLeader     Boolean       @default(false) // Team leaders can manage backup cleaners
  calendarToken  String?       @unique // For ICS feed URL
  teamId         String?       // Team this cleaner belongs to (null = independent)
  referredByCode String?       // Team referral code used during signup

  // Google Calendar Integration
  googleCalendarConnected Boolean   @default(false)
  googleCalendarSyncedAt  DateTime?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings         Booking[]
  reviews          Review[]
  conversations    Conversation[]
  ledTeam          Team?             @relation("TeamLeader")
  memberOfTeam     Team?             @relation("TeamMembers", fields: [teamId], references: [id])
  teamJoinRequests TeamJoinRequest[]
  arrivalPreps     ArrivalPrep[]
  availability     CleanerAvailability[]

  // AI Sales Agent
  aiSettings           CleanerAISettings?
  aiUsageLogs          AIUsageLog[]
  conversationSummaries ConversationSummary[]
  pendingOnboardings   PendingOnboarding[]
  responseTrackers     BookingResponseTracker[]
}

model Owner {
  id                 String   @id @default(cuid())
  userId             String   @unique
  trusted            Boolean  @default(false)
  referredBy         String?
  totalBookings      Int      @default(0)
  cleanerRating      Decimal? @db.Decimal(3, 2)
  cleanerReviewCount Int      @default(0)
  referralCode       String   @unique
  referralCredits    Decimal  @default(0) @db.Decimal(10, 2)
  preferredExtras    String[] @default([]) // Remember favorite arrival extras
  adminNotes         String?  @db.Text      // CRM notes (preferences, special instructions)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties    Property[]
  bookings      Booking[]
  reviews       Review[]
  conversations Conversation[]
  arrivalPreps  ArrivalPrep[]
}

model Property {
  id        String   @id @default(cuid())
  ownerId   String
  name      String
  address   String
  bedrooms  Int
  bathrooms Int
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner         Owner             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  bookings      Booking[]
  comments      InternalComment[]
  conversations Conversation[]
  arrivalPreps  ArrivalPrep[]
}

model Booking {
  id         String        @id @default(cuid())
  cleanerId  String
  ownerId    String
  propertyId String
  status     BookingStatus @default(PENDING)
  service    String
  price      Decimal       @db.Decimal(10, 2)
  hours      Int
  date       DateTime
  time       String
  notes       String?       @db.Text
  createdByAI Boolean       @default(false) // Booking created by AI sales agent
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  cleaner  Cleaner  @relation(fields: [cleanerId], references: [id])
  owner    Owner    @relation(fields: [ownerId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])
  review   Review?
  responseTracker BookingResponseTracker?
}

model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique
  cleanerId String
  ownerId   String
  rating    Int
  text      String   @db.Text
  featured  Boolean  @default(false)
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  cleaner Cleaner @relation(fields: [cleanerId], references: [id])
  owner   Owner   @relation(fields: [ownerId], references: [id])
}

model InternalComment {
  id          String   @id @default(cuid())
  propertyId  String
  cleanerId   String
  cleanerName String
  text        String   @db.Text
  createdAt   DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model Feedback {
  id        String           @id @default(cuid())
  category  FeedbackCategory
  mood      FeedbackMood
  message   String?          @db.Text
  page      String
  userType  String?
  userId    String?
  status    FeedbackStatus   @default(NEW)
  votes     Int              @default(0)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

// ============================================
// Messaging with Translation
// ============================================

model Conversation {
  id         String   @id @default(cuid())
  ownerId    String?  // Optional: for owner-cleaner conversations
  cleanerId  String
  adminId    String?  // Optional: for admin-cleaner conversations
  propertyId String?  // Optional: link to a specific property
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  owner    Owner?    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  cleaner  Cleaner   @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
  admin    User?     @relation("AdminConversations", fields: [adminId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  messages Message[]

  @@unique([ownerId, cleanerId]) // One conversation per owner-cleaner pair
  @@unique([adminId, cleanerId]) // One conversation per admin-cleaner pair
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String   // User ID of sender
  senderRole     UserRole // OWNER or CLEANER

  // Original message
  originalText   String   @db.Text
  originalLang   String   @db.VarChar(10) // e.g., 'en', 'es', 'de', 'fr'

  // Translated message
  translatedText String?  @db.Text
  translatedLang String?  @db.VarChar(10)

  // Metadata
  isRead         Boolean  @default(false)
  isAIGenerated  Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

// ============================================
// Team Management
// ============================================

model Team {
  id           String   @id @default(cuid())
  name         String
  leaderId     String   @unique
  referralCode String   @unique // TEAM-{slug}-{4digits}
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  leader       Cleaner           @relation("TeamLeader", fields: [leaderId], references: [id])
  members      Cleaner[]         @relation("TeamMembers")
  joinRequests TeamJoinRequest[]
}

model TeamJoinRequest {
  id          String                @id @default(cuid())
  teamId      String
  cleanerId   String
  status      TeamJoinRequestStatus @default(PENDING)
  message     String?               @db.Text
  createdAt   DateTime              @default(now())
  respondedAt DateTime?

  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  cleaner Cleaner @relation(fields: [cleanerId], references: [id], onDelete: Cascade)

  @@unique([teamId, cleanerId])
}

// ============================================
// Arrival Prep (I'm Coming Home Feature)
// ============================================

enum ArrivalPrepStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

model ArrivalPrep {
  id          String            @id @default(cuid())
  ownerId     String
  propertyId  String
  cleanerId   String
  arrivalDate DateTime
  arrivalTime String            // e.g., "14:00"
  extras      String[]          // ["fridge", "flowers", "linens", "basket"]
  notes       String?           @db.Text
  status      ArrivalPrepStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  owner    Owner    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  cleaner  Cleaner  @relation(fields: [cleanerId], references: [id])
}

// ============================================
// Cleaner Availability (Google Calendar Sync)
// ============================================

enum AvailabilitySource {
  MANUAL
  GOOGLE_CALENDAR
  BOOKING
}

model CleanerAvailability {
  id            String             @id @default(cuid())
  cleanerId     String
  date          DateTime           @db.Date
  startTime     String             // "09:00" format
  endTime       String             // "17:00" format
  isAvailable   Boolean            @default(true) // false = blocked/busy
  source        AvailabilitySource @default(MANUAL)
  googleEventId String?            // For synced Google Calendar events
  title         String?            // Optional event title (for display)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  cleaner Cleaner @relation(fields: [cleanerId], references: [id], onDelete: Cascade)

  @@unique([cleanerId, date, startTime, endTime])
  @@index([cleanerId, date])
  @@index([cleanerId, date, isAvailable])
}

// ============================================
// AI Sales Agent
// ============================================

model CleanerAISettings {
  id          String   @id @default(cuid())
  cleanerId   String   @unique
  aiEnabled   Boolean  @default(true)  // AI responds to owner messages
  autoBooking Boolean  @default(true)  // AI can create confirmed bookings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cleaner Cleaner @relation(fields: [cleanerId], references: [id], onDelete: Cascade)
}

model AIUsageLog {
  id             String   @id @default(cuid())
  cleanerId      String
  conversationId String
  action         String   // RESPONSE, BOOKING_CREATED
  tokensUsed     Int
  createdAt      DateTime @default(now())

  cleaner Cleaner @relation(fields: [cleanerId], references: [id], onDelete: Cascade)

  @@index([cleanerId, createdAt])
}

model ConversationSummary {
  id             String   @id @default(cuid())
  conversationId String
  cleanerId      String
  summary        String   @db.Text
  bookingCreated Boolean  @default(false)
  bookingId      String?
  createdAt      DateTime @default(now())

  cleaner Cleaner @relation(fields: [cleanerId], references: [id], onDelete: Cascade)

  @@index([cleanerId, createdAt])
}

// ============================================
// Public AI Onboarding (Magic Link Signup)
// ============================================

enum OnboardingStatus {
  PENDING     // Waiting for user to click magic link
  COMPLETED   // User signed up and booking created
  EXPIRED     // Link expired (24 hours)
}

// ============================================
// Notifications
// ============================================

enum NotificationType {
  BOOKING_REQUEST     // New booking needs confirmation
  BOOKING_REMINDER    // Reminder to respond to booking
  BOOKING_ESCALATED   // Booking escalated to team
  BOOKING_AUTO_DECLINED // Booking auto-declined
  BOOKING_CONFIRMED   // Booking was confirmed
  BOOKING_COMPLETED   // Booking was completed
  TEAM_COVERAGE       // Team member covered a booking
  NEW_REVIEW          // New review received
  AI_ACTION           // AI took an action
}

model Notification {
  id          String           @id @default(cuid())
  userId      String           // User to notify
  type        NotificationType
  title       String
  message     String           @db.Text
  data        Json?            // Additional data (bookingId, etc)
  read        Boolean          @default(false)
  actionUrl   String?          // Link to take action
  createdAt   DateTime         @default(now())

  @@index([userId, read, createdAt])
}

// Track booking response deadlines
model BookingResponseTracker {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  cleanerId     String

  // Reminder schedule
  reminder1SentAt  DateTime?  // After 1 hour
  reminder2SentAt  DateTime?  // After 2 hours (also escalate to team)
  escalatedAt      DateTime?  // When team was notified
  autoDeclinedAt   DateTime?  // After 6 hours
  respondedAt      DateTime?  // When cleaner responded

  createdAt     DateTime @default(now())

  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  cleaner       Cleaner  @relation(fields: [cleanerId], references: [id])

  @@index([cleanerId, createdAt])
}

model PendingOnboarding {
  id          String            @id @default(cuid())
  cleanerId   String            // Cleaner being booked
  token       String            @unique // Magic link token

  cleaner     Cleaner           @relation(fields: [cleanerId], references: [id])

  // Collected visitor info
  visitorName  String
  visitorPhone String
  visitorEmail String?

  // Property details
  bedrooms     Int
  bathrooms    Int
  outdoorAreas String[]         // ["pool", "garden", "terrace"]
  accessNotes  String?          @db.Text // Key location, gate codes, parking
  address      String?

  // Booking details
  serviceType  String           // regular, deep, arrival
  servicePrice Decimal          @db.Decimal(10, 2)
  serviceHours Int
  preferredDate DateTime
  preferredTime String

  // Status
  status       OnboardingStatus @default(PENDING)
  expiresAt    DateTime         // 24 hours from creation
  createdAt    DateTime         @default(now())
  completedAt  DateTime?

  // Result (after completion)
  userId       String?          // Created user ID
  ownerId      String?          // Created owner ID
  propertyId   String?          // Created property ID
  bookingId    String?          // Created booking ID

  @@index([token])
  @@index([cleanerId, status])
}
